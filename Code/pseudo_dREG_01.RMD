---
title: "pseudo_dREG_01.RMD"
author: "Stefano Pellegrini"
date: "11/25/2020"
output: pdf_document
---

```{r}
library(rtracklayer)
library(tidyverse)
library(ggforce)
library(GenomicRanges)
library(reshape2)
library(RColorBrewer)
```

```{r}
# Load data
ATAC_granges <- import("../Data/ATAC_idr.optimal_peak.narrowPeak.gz", format="gz")
CAGE_granges <- import("../Data/ctss_files/hg38.CAGE_AF7N_Pool_81_A2.filt.ctss.bed.gz", format="gz")
genome(ATAC_granges) <- "hg38"
genome(CAGE_granges) <- "hg38"
ATAC_granges
CAGE_granges
```

# Extract the positive set

```{r}
# Extend ATAC peaks 250 bp in both directions
ATAC_granges_peaks <- GRanges(seqnames = seqnames(ATAC_granges),
                              ranges = IRanges(start = start(ATAC_granges) + ATAC_granges$peak, width = 1),
                              strand = strand(ATAC_granges))
genome(ATAC_granges_peaks) <- "hg38"

start(ATAC_granges_peaks) <- start(ATAC_granges_peaks) - 250
end(ATAC_granges_peaks) <- end(ATAC_granges_peaks) + 250
ranges(ATAC_granges_peaks)
ATAC_granges_peaks
```

```{r}
# Remove overlapping regions
ATAC_peaks_filtered <- rownames_to_column(as.data.frame(ATAC_granges_peaks)) %>% 
  as_tibble() %>% mutate(overlaps = countOverlaps(ATAC_granges_peaks)) %>% 
  filter(overlaps==1)
ATAC_peaks_filtered

ATAC_granges_peaks_filtered <- ATAC_granges_peaks[as.numeric(ATAC_peaks_filtered$rowname)]
ATAC_granges_peaks_filtered
ranges(ATAC_granges_peaks_filtered)

length(ATAC_granges)
length(ATAC_granges_peaks_filtered)

# Get number of windows for each chr
table(seqnames(ATAC_granges_peaks_filtered))

# Alternatively I can collpase overlapping ranges
GenomicRanges::reduce(ATAC_granges_peaks)
```

## Extract the windows profile

```{r}
# Report time execution
report_time_execution <- function(fun){
  start_time <- Sys.time()
  output <- fun
  end_time <- Sys.time()
  print(end_time - start_time)
return(output)
}

# Return score if the position in present, 0 otherwise
get_count_vector <- function(pos, df){
  if (pos %in% df$atac_relative_pos) {
  return(df$score[which(df$atac_relative_pos == pos)])
} else {return(0)}
}

# Return score vector for each position for both strands
get_count_vector_both_strands <- function(df){
  plus_count_vector <- sapply(1:501, get_count_vector, df = df[df$strand == "+",])
  minus_count_vector <- sapply(1:501, get_count_vector, df = df[df$strand == "-",])
  return(c(plus_count_vector, minus_count_vector))
}
  
# Return the CAGE profiles of the (CAGE) overlapping ATAC regions
get_chr_windows_profiles <- function(cage_granges, atac_granges, chr){
  # Select chromosome
  cage_granges <- cage_granges[seqnames(cage_granges) == chr]
  atac_granges <- atac_granges[seqnames(atac_granges) == chr]
  # Add all information into one df
  overlaps <- findOverlaps(cage_granges, atac_granges)                   # Index of overlapping CAGE fragment
  length(overlaps)  
  # Check if there are ATAC positive windows overlapping CAGE data
  if (length(overlaps) > 0){                                                   
    df <- cage_granges[queryHits(overlaps)]                              # Keep only overlapping CAGE data
    df$index_overlapping_atac <- subjectHits(overlaps)                   # Add index of overlapping ATAC   
    df %>% as_tibble() %>%                                               # Add ATAC start site and relative position
      mutate(atac_start = start(atac_granges[subjectHits(overlaps)]),
             atac_relative_pos = start - atac_start + 1) -> df
    # Extract profiles of each (CAGE) overlapping ATAC region
    profiles <- by(data = df, 
                   INDICES = df$index_overlapping_atac, 
                   FUN = function(x){get_count_vector_both_strands(x)})
    profiles <- data.frame(do.call(rbind, profiles))
    colnames(profiles) <- c(paste("Plus_", 1:501, sep = ""), paste("Minus_", 1:501, sep = ""))
    # Add metadata information
    profiles <- profiles %>% mutate(# atac_index = sort(unique(subjectHits(overlaps))),
                                    atac_start = start(atac_granges[as.numeric(rownames(profiles))]),
                                    chr = chr) %>% relocate(c(chr, atac_start), .before = Plus_1) 
    return(profiles)
  } 
  else {
    print(paste(chr, "contains no overlapping windows"))
    return(NULL)
  }
}

# Return the windows profiles for all chromosomes
get_windows_profiles <- function(cage_granges, atac_granges){
  chromosomes <- unique(seqnames(cage_granges))
  list_chr_profiles <- lapply(chromosomes, function(x) 
        {get_chr_windows_profiles(cage_granges = cage_granges, 
         atac_granges = atac_granges,
         chr = x)})
  final_df <- data.frame(do.call(rbind, list_chr_profiles))  
  return(final_df)
}

pos_windows_profiles <- report_time_execution(get_windows_profiles(CAGE_granges, 
                                                                   ATAC_granges_peaks_filtered))
pos_windows_metadata <- pos_windows_profiles %>% select(chr, atac_start)
pos_windows_profiles <- pos_windows_profiles %>% select(-chr, -atac_start)
pos_windows_metadata
pos_windows_profiles
```

## Exploration of the obtained profiles

```{r}
## Explore the resulting profiles

# Plot the distribution of CAGE coverage for ATAC-Seq peak relative positions
get_cage_distribution_by_peak_position <- function(peaks_profile_df){
  apply(peaks_profile_df, 2, sum) %>% as_tibble() %>% 
  mutate(pos = c(-250:250, -250:250), strand = c(rep("+", 501), rep("-", 501))) %>% 
  rename(score = value) %>% relocate(score, .after = strand) %>%
  mutate(score = ifelse(strand == "-", -score, score))
}
cage_distribution_by_peak_position <- get_cage_distribution_by_peak_position(pos_windows_profiles)

cage_distribution_by_peak_position %>% ggplot(aes(x = pos, y = score, color = strand)) + geom_line() +
 # facet_zoom(ylim=c(-3000, 1000), shrink = FALSE) +
  labs(title = "CAGE score distribution over ATAC-Seq peaks relative position (All chr)",  
       x = "Relative position to ATAC mid peaks", y = "Sum of scores over windows") + 
   scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) + theme_bw()

# Plot distribution of ATAC-Seq peaks CAGE total coverage 
get_windows_total_cage_score_distribution <- function(peaks_profile_df){
  peaks_profile_df %>% 
    count(apply(peaks_profile_df, 1, sum)) %>% 
    rename(total_score = "apply(peaks_profile_df, 1, sum)", n_atac_peaks = n) %>%
    relocate(total_score, .after = n_atac_peaks) 
}

windows_total_cage_score_distribution <- get_windows_total_cage_score_distribution(pos_windows_profiles)
windows_total_cage_score_distribution
windows_total_cage_score_distribution %>% arrange(desc(total_score))

# Focus on ATAC-Seq peaks number
windows_total_cage_score_distribution %>% filter(total_score < 50) %>% 
  ggplot(aes(x = total_score, y = n_atac_peaks)) + 
  geom_bar(stat = "identity", color = "black", fill = brewer.pal(8,"Dark2")[1]) + 
  scale_y_continuous(breaks = scales::pretty_breaks(n = 15)) +
  labs(title = "Windows profiles total score distribution", 
       y = "N. Windows profiles",
       x = "Total CAGE score",
       fill = NA) +
  theme_bw() +
  theme(legend.position = "none")

# Focus on CAGE total coverage per peak
windows_total_cage_score_distribution %>% mutate(type = "Windows profiles") %>% 
  ggplot(aes(x = type, y = total_score)) + geom_violin(fill= brewer.pal(8,"Greys")[3]) +
  geom_jitter(aes(size = n_atac_peaks, col = n_atac_peaks), alpha=0.5) + theme_bw() +
  labs(title = "Windows profiles total score distribution", 
     x = NA,
     y = "Total CAGE score",
     size = "N. Windows profiles",
     col = "") +
  facet_zoom(ylim=c(0, 10000), shrink = FALSE) +
  scale_colour_gradientn(colours = c("blue", "red"), values = c(0, 0.5, 1)) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10)) +
  theme(axis.title.x=element_blank())

# Plot the maximum tss score of each window
min_tss_score_distribution <- rownames_to_column(pos_windows_profiles, var = "atac_start") %>% 
  mutate(max_tss_score = apply(pos_windows_profiles, 1, max)) %>% 
  select(atac_start, max_tss_score) %>% group_by(max_tss_score) %>% count()

min_tss_score_distribution

min_tss_score_distribution %>% ggplot(aes(x = max_tss_score, y = n, fill = "red")) + 
  geom_bar(stat = "identity", color = "black", fill = brewer.pal(8,"Dark2")[3]) + 
  facet_zoom(ylim=c(0, 60), shrink = FALSE) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 15)) +
  coord_cartesian(xlim = c(0, 50)) +
  labs(title = "Max TSS score distribution", 
       y = "N. ATAC windows profiles",
       x = "Max TSS score",
       fill = NA) +
  theme_bw() +
  theme(legend.position = "none")
```

## Positive windows filtering and exploration

```{r}
## Positive set filtering

# Try different filters and observe the resulting profiles
windows_profiles_filter <- function(windows_profile, 
                                    windows_metadata = NA,
                                    threshold = 1, fun = max){
  filter <- apply(windows_profile, 1, fun) > threshold
  if (!missing(windows_metadata)) {
    output <- list()
    output$profiles <-  windows_profile[filter,]
    output$metadata <- windows_metadata[filter,]
  } else {
    output <- windows_profile[filter,]
  }
  return(output)
}

windows_profile_filtered_atleast_2_sum <- windows_profiles_filter(pos_windows_profiles, fun = sum)
windows_profile_filtered_atleast_2_max <- windows_profiles_filter(pos_windows_profiles)
windows_profile_filtered_atleast_3_max <- windows_profiles_filter(pos_windows_profiles, threshold = 2)

print(paste("Original windows number:", nrow(pos_windows_profiles)))
print(paste("N. windows after filtering (at least 2 reads in total):", nrow(windows_profile_filtered_atleast_2_sum)))
print(paste("N. windows after filtering (at least a TSS with 2 reads):", nrow(windows_profile_filtered_atleast_2_max)))
print(paste("N. windows after filtering (at least a TSS with 3 reads):", nrow(windows_profile_filtered_atleast_3_max)))


## Plot after filtering

cage_distribution_by_peak_position <- get_cage_distribution_by_peak_position(windows_profile_filtered_atleast_2_max)

cage_distribution_by_peak_position %>% ggplot(aes(x = pos, y = score, color = strand)) + geom_line() +
 # facet_zoom(ylim=c(-3000, 1000), shrink = FALSE) +
  labs(title = "CAGE score distribution over ATAC-Seq peaks relative position (All chr)",  
       x = "Relative position to ATAC mid peaks", y = "Sum of scores over windows") + 
   scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) + theme_bw()

# Plot distribution of ATAC-Seq peaks CAGE total coverage 
get_windows_total_cage_score_distribution <- function(peaks_profile_df){
  peaks_profile_df %>% 
    count(apply(peaks_profile_df, 1, sum)) %>% 
    rename(total_score = "apply(peaks_profile_df, 1, sum)", n_atac_peaks = n) %>%
    relocate(total_score, .after = n_atac_peaks) 
}

windows_total_cage_score_distribution <- get_windows_total_cage_score_distribution(windows_profile_filtered_atleast_2_max)
windows_total_cage_score_distribution
windows_total_cage_score_distribution %>% arrange(desc(total_score))

# Focus on ATAC-Seq peaks number
windows_total_cage_score_distribution %>% filter(total_score < 50) %>% 
  ggplot(aes(x = total_score, y = n_atac_peaks)) + 
  geom_bar(stat = "identity", color = "black", fill = brewer.pal(8,"Dark2")[1]) + 
  scale_y_continuous(breaks = scales::pretty_breaks(n = 15)) +
  labs(title = "Windows profiles total score distribution (All chr)", 
       y = "N. Windows profiles",
       x = "Total CAGE score",
       fill = NA) +
  theme_bw() +
  theme(legend.position = "none")

# Focus on CAGE total coverage per peak
windows_total_cage_score_distribution %>% mutate(type = "Windows profiles") %>% 
  ggplot(aes(x = type, y = total_score)) + geom_violin(fill= brewer.pal(8,"Greys")[3]) +
  geom_jitter(aes(size = n_atac_peaks, col = n_atac_peaks), alpha=0.5) + theme_bw() +
  labs(title = "Windows profiles total score distribution (All chr)", 
     x = NA,
     y = "Total CAGE score",
     size = "N. Windows profiles",
     col = "") +
  facet_zoom(ylim=c(0, 10000), shrink = FALSE) +
  scale_colour_gradientn(colours = c("blue", "red"), values = c(0, 0.5, 1)) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10)) +
  theme(axis.title.x=element_blank())

# Plot the maximum tss score of each window
min_tss_score_distribution <- rownames_to_column(pos_windows_profiles, var = "atac_start") %>% 
  mutate(max_tss_score = apply(pos_windows_profiles, 1, max)) %>% 
  select(atac_start, max_tss_score) %>% group_by(max_tss_score) %>% count()

min_tss_score_distribution

min_tss_score_distribution %>% ggplot(aes(x = max_tss_score, y = n, fill = "red")) + 
  geom_bar(stat = "identity", color = "black", fill = brewer.pal(8,"Dark2")[3]) + 
  facet_zoom(ylim=c(0, 60), shrink = FALSE) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 15)) +
  coord_cartesian(xlim = c(0, 50)) +
  labs(title = "Max TSS score distribution (All chr)", 
       y = "N. ATAC windows profiles",
       x = "Max TSS score",
       fill = NA) +
  theme_bw() +
  theme(legend.position = "none")
```

## Explore some differnet chromosomes profiles and score distribution

```{r}
# Plot some profiles
plot_positive_set_profile <- function(windows_profile,
                                      metadata_profile,
                                      chr,
                                      ylim = c(-50, 50), range = 1:104, sort = FALSE){
  windows_profile <- windows_profile[metadata_profile$chr == chr,]
  windows_profile %>% 
    mutate(total_coverage = apply(windows_profile, 1, sum),
           max_coverage = apply(windows_profile, 1, max)) %>%
    mutate(window = paste("w_", 1:nrow(windows_profile), 
                          "\n(T=", as.character(total_coverage), ", \nM=", 
                          max_coverage, ")", sep = "")) %>%
    relocate(c(window, total_coverage), .before = Plus_1) -> temp
  if (sort == TRUE){
    temp %>% arrange(desc(total_coverage)) %>% slice(range) -> temp
  } 
  
  temp <- temp %>% select(-total_coverage, -max_coverage) %>% slice(range) %>% melt()
  temp$value[grepl("^M", temp$variable)] <- -temp$value[grepl("^M", temp$variable)] 
  temp$strand[grepl("^M", temp$variable)] <- "-"
  temp$strand[grepl("^P", temp$variable)] <- "+"
  temp$variable <- as.numeric(gsub("\\D", "", temp$variable)) - 251
  
  
  temp %>% ggplot(aes(x = variable, y = value, color = strand)) + geom_line() + 
    facet_wrap(~window, ncol = 8, strip.position = "left") +
    coord_cartesian(ylim = ylim) +
    labs(title = paste("Positive set windows profiles (", 
                       deparse(substitute(range)), ", ", chr, ")", sep = ""), 
         y = "TSS score",
         x = "Relative position to ATAC-Seq mid peak",
         fill = NA) +
    theme_bw() -> plot
  return(plot)
}

positive_windows_filtered <- windows_profiles_filter(pos_windows_profiles,
                                                     pos_windows_metadata)

plot_positive_set_profile(positive_windows_filtered$profiles,
                          positive_windows_filtered$metadata, chr = "chr1", sort=TRUE) 
plot_positive_set_profile(positive_windows_filtered$profiles,
                          positive_windows_filtered$metadata, chr = "chr2") 
plot_positive_set_profile(positive_windows_filtered$profiles,
                          positive_windows_filtered$metadata, chr = "chr3") 
plot_positive_set_profile(positive_windows_filtered$profiles,
                          positive_windows_filtered$metadata, chr = "chr8") 
plot_positive_set_profile(positive_windows_filtered$profiles,
                          positive_windows_filtered$metadata, chr = "chr15") 
plot_positive_set_profile(positive_windows_filtered$profiles,
                          positive_windows_filtered$metadata, chr = "chrX") 
```

## Exploration of different chromosomes profiles

```{r}
# Get the distribution of CAGE score over one chr windows positions 
get_score_distribution_by_pos_one_chr <- function(list_windows, chr){
  windows_profile <- list_windows$profiles[list_windows$metadata == chr,]
  score_distribution <- get_cage_distribution_by_peak_position(windows_profile)
  score_distribution$chr = chr
  return(score_distribution)  
}

# Get the distribution of CAGE score for all chr
get_score_distribution_by_pos_all_chr <- function(list_windows){
  list_df <- lapply(unique(list_windows$metadata$chr), function(x){
    get_score_distribution_by_pos_one_chr(list_windows, as.character(x))}) 
  return(data.frame(do.call(rbind, list_df)))
}

pos_windows_score_distribution_by_pos_all_chr <-   
  get_score_distribution_by_pos_all_chr(positive_windows_filtered)
  
pos_windows_score_distribution_by_pos_all_chr %>% 
  ggplot(aes(x = pos, y = score, color = strand)) + geom_line() +
  labs(title = "Positive set CAGE score distribution over ATAC-Seq peaks relative position",  
       x = "Relative position to ATAC mid peaks", y = "Sum of scores over windows") + 
  coord_cartesian(ylim = c(-1000, 1000)) +
  facet_wrap(~factor(chr,
                     levels = paste("chr", c(1:22, "X", "Y"), sep=""))) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 5)) + theme_bw()
```








